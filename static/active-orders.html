<!DOCTYPE html>
<html>

<head>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link rel="stylesheet" as="style" onload="this.rel='stylesheet'"
        href="https://fonts.googleapis.com/css2?display=swap&family=Work+Sans%3Awght%40400%3B500%3B700%3B900" />
    <title>UNO Spicchio - Активные Заказы</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
</head>

<body class="bg-[#fcf8f8]">
    <div class="relative flex h-auto min-h-screen w-full flex-col"
        style='font-family: "Work Sans", "Noto Sans", sans-serif;'>
        <div class="layout-container flex h-full grow flex-col">
            <header
                class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#f3e7e8] px-10 py-3">
                <div class="flex items-center gap-4 text-[#1b0e0e]">
                    <h2 class="text-[#1b0e0e] text-lg font-bold leading-tight tracking-[-0.015em]">UNO Spicchio</h2>
                </div>

                <div class="flex items-center gap-4">
                    <button onclick="logout()" class="text-sm font-medium text-[#994d51] hover:text-[#ea2a33]">
                        Выход
                    </button>
                    <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full h-10 w-10"
                        style='background-image: url("https://i.pravatar.cc/40");'></div>
                </div>
            </header>

            <main class="flex flex-1 gap-4 p-4 lg:gap-8 lg:p-8">
                <aside class="flex flex-col gap-4 w-full max-w-[280px] p-4 rounded-lg bg-white border border-[#e7d0d1]">
                    <h1 class="text-[#1b0e0e] text-base font-medium leading-normal">UNO Spicchio</h1>
                    <div class="flex flex-col gap-2">
                        <a href="active-orders.html" class="flex items-center gap-3 px-3 py-2 rounded-lg bg-[#f3e7e8]">
                            <p class="text-[#1b0e0e] text-sm font-medium leading-normal">Заказы</p>
                        </a>
                        <a href="dashboard.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-[#f3e7e8]"
                            id="dashboardLink">
                            <p class="text-[#1b0e0e] text-sm font-medium leading-normal">Аналитика</p>
                        </a>
                    </div>
                </aside>

                <div class="flex-1 flex flex-col">
                    <div class="flex flex-wrap justify-between items-center gap-3 p-4">
                        <div class="flex min-w-72 flex-col gap-3">
                            <h1 class="text-[#1b0e0e] tracking-light text-[32px] font-bold leading-tight">Активные
                                заказы</h1>
                            <p class="text-[#994d51] text-sm font-normal leading-normal">Просмотр всех текущих заказов в
                                реальном времени</p>
                        </div>
                        <a href="create-order.html" id="newOrderBtn"
                            class="flex items-center justify-center rounded-lg h-12 px-5 bg-[#ea2a33] text-white text-base font-bold">
                            + Новый заказ
                        </a>
                    </div>

                    <div class="pb-3">
                        <div id="tabs" class="flex border-b border-[#e7d0d1] px-4 gap-8">
                            <a href="#" data-status="all"
                                class="tab-link flex flex-col items-center justify-center border-b-[3px] border-b-[#ea2a33] text-[#1b0e0e] pb-[13px] pt-4">
                                <p class="text-sm font-bold">Все заказы</p>
                            </a>
                            <a href="#" data-status="new"
                                class="tab-link flex flex-col items-center justify-center border-b-[3px] border-b-transparent text-[#994d51] pb-[13px] pt-4">
                                <p class="text-sm font-bold">Новые</p>
                            </a>
                            <a href="#" data-status="in_progress"
                                class="tab-link flex flex-col items-center justify-center border-b-[3px] border-b-transparent text-[#994d51] pb-[13px] pt-4">
                                <p class="text-sm font-bold">В процессе</p>
                            </a>
                            <a href="#" data-status="ready"
                                class="tab-link flex flex-col items-center justify-center border-b-[3px] border-b-transparent text-[#994d51] pb-[13px] pt-4">
                                <p class="text-sm font-bold">Готово</p>
                            </a>
                        </div>
                    </div>

                    <div class="px-4 py-3">
                        <div class="flex overflow-hidden rounded-lg border border-[#e7d0d1] bg-white">
                            <table class="w-full">
                                <thead class="bg-[#fcf8f8]">
                                    <tr>
                                        <th class="p-3 text-left text-sm font-medium text-[#1b0e0e] w-[10%]">Номер</th>
                                        <th class="p-3 text-left text-sm font-medium text-[#1b0e0e] w-[15%]">Стол</th>
                                        <th class="p-3 text-left text-sm font-medium text-[#1b0e0e] w-[15%]">Статус</th>
                                        <th class="p-3 text-left text-sm font-medium text-[#1b0e0e] w-[15%]">Время</th>
                                        <th class="p-3 text-left text-sm font-medium text-[#1b0e0e] w-[35%]">Детали</th>
                                        <th class="p-3 text-left text-sm font-medium text-[#1b0e0e] w-[10%]">Сумма</th>
                                    </tr>
                                </thead>
                                <tbody id="orders-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8080/api';
        const ordersTableBody = document.getElementById('orders-table-body');
        const tabsContainer = document.getElementById('tabs');
        let allOrders = [];
        let currentFilter = 'all';
        let currentUser = null;

        function checkAuth() {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                window.location.href = 'login.html';
                return false;
            }
            return token;
        }

        async function loadUserData() {
            const token = checkAuth();
            if (!token) return;

            try {
                const response = await fetch(`${API_BASE_URL}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();

                    if (result.success && result.data) {
                        currentUser = result.data;
                    } else if (result.id) {
                        currentUser = result;
                    }

                    if (currentUser) {
                        if (currentUser.role !== 'admin' && currentUser.role !== 'manager') {
                            document.getElementById('dashboardLink').style.display = 'none';
                        }

                        if (currentUser.role !== 'waiter' && currentUser.role !== 'admin') {
                            document.getElementById('newOrderBtn').style.display = 'none';
                        }
                    }
                } else {
                    logout();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                logout();
            }
        }

        function logout() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_data');
            window.location.href = 'login.html';
        }

        function getStatusInfo(status) {
            switch (status) {
                case 'new':
                    return { text: 'Новый', colorClass: 'bg-blue-100 text-blue-800' };
                case 'in_progress':
                    return { text: 'В процессе', colorClass: 'bg-yellow-100 text-yellow-800' };
                case 'ready':
                    return { text: 'Готово', colorClass: 'bg-green-100 text-green-800' };
                case 'paid':
                    return { text: 'Оплачен', colorClass: 'bg-gray-100 text-gray-800' };
                default:
                    return { text: status, colorClass: 'bg-gray-100 text-gray-800' };
            }
        }

        function formatTimeAgo(dateString) {
            const now = new Date();
            const orderTime = new Date(dateString);
            const diffMs = now - orderTime;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffDays > 0) {
                return `${diffDays} дн. назад`;
            } else if (diffHours > 0) {
                return `${diffHours} ч. ${diffMins % 60} мин. назад`;
            } else if (diffMins > 0) {
                return `${diffMins} мин. назад`;
            } else {
                return 'Только что';
            }
        }

        function formatLocalTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        async function fetchOrderDetails(orderId) {
            const token = checkAuth();
            if (!token) return [];

            try {
                const response = await fetch(`${API_BASE_URL}/orders/${orderId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();

                    let order;
                    if (result.success && result.data) {
                        order = result.data;
                    } else if (result.id) {
                        order = result;
                    }

                    return order?.items || [];
                }
            } catch (error) {
                console.error('Error fetching order details:', error);
            }
            return [];
        }

        async function renderOrders() {
            ordersTableBody.innerHTML = '';
            const filteredOrders = allOrders.filter(order => {
                if (currentFilter === 'all') return order.status !== 'paid';
                return order.status === currentFilter;
            });

            if (filteredOrders.length === 0) {
                ordersTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-gray-500">Нет заказов в этой категории.</td></tr>`;
                return;
            }

            for (const order of filteredOrders) {
                const tr = document.createElement('tr');
                tr.className = 'border-t border-t-[#e7d0d1] hover:bg-gray-50 cursor-pointer';

                const statusInfo = getStatusInfo(order.status);
                const timeAgo = formatTimeAgo(order.created_at);
                const localTime = formatLocalTime(order.created_at);

                // Получаем детали заказа
                const items = await fetchOrderDetails(order.id);
                const details = items && items.length > 0
                    ? items.map(item => `${item.dish?.name || 'Блюдо'} (x${item.qty})`).join(', ')
                    : 'Загрузка...';

                // Получаем имя стола
                const tableName = order.table?.name || order.table_name || `Стол ${order.table_number}`;

                tr.innerHTML = `
                    <td class="p-3 text-sm font-medium">#${order.id}</td>
                    <td class="p-3 text-sm">${tableName}</td>
                    <td class="p-3">
                        <div class="inline-flex items-center justify-center rounded-full h-8 px-4 text-sm font-medium ${statusInfo.colorClass}">
                            ${statusInfo.text}
                        </div>
                    </td>
                    <td class="p-3 text-sm text-[#994d51]">
                        <div class="font-semibold">${timeAgo}</div>
                        <div class="text-xs text-gray-500">${localTime}</div>
                    </td>
                    <td class="p-3 text-sm text-[#994d51] truncate max-w-xs" title="${details}">${details}</td>
                    <td class="p-3 text-sm font-semibold">${order.total.toFixed(2)} ₸</td>
                `;
                ordersTableBody.appendChild(tr);
            }
        }

        async function fetchOrders() {
            const token = checkAuth();
            if (!token) return;

            try {
                const response = await fetch(`${API_BASE_URL}/orders`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Orders API response:', result);

                    if (result.success && result.data) {
                        allOrders = result.data;
                    } else if (Array.isArray(result)) {
                        allOrders = result;
                    } else {
                        allOrders = [];
                    }

                    console.log('Parsed orders:', allOrders);
                    await renderOrders();
                } else if (response.status === 401) {
                    logout();
                } else {
                    const errorText = await response.text();
                    console.error('Ошибка при загрузке заказов:', response.status, errorText);
                }
            } catch (error) {
                console.error('Не удалось подключиться к серверу:', error);
                ordersTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-red-600">Не удалось загрузить данные.</td></tr>`;
            }
        }

        tabsContainer.addEventListener('click', (event) => {
            const clickedTab = event.target.closest('.tab-link');
            if (!clickedTab) return;
            event.preventDefault();

            tabsContainer.querySelectorAll('.tab-link').forEach(tab => {
                tab.classList.remove('border-b-[#ea2a33]', 'text-[#1b0e0e]');
                tab.classList.add('border-b-transparent', 'text-[#994d51]');
            });

            clickedTab.classList.add('border-b-[#ea2a33]', 'text-[#1b0e0e]');
            clickedTab.classList.remove('border-b-transparent', 'text-[#994d51]');

            currentFilter = clickedTab.dataset.status;
            renderOrders();
        });

        document.addEventListener('DOMContentLoaded', () => {
            loadUserData();
            fetchOrders();
            // Обновляем каждые 30 секунд
            setInterval(fetchOrders, 30000);
        });
    </script>
</body>

</html>