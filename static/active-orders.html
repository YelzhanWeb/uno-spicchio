<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Активные заказы - UNO Spicchio</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>

    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#E53E3E", // red-600
                        "background-light": "#F9FAFB", // gray-50
                        "background-dark": "#111827", // gray-900
                    },
                    fontFamily: {
                        display: ["Inter", "sans-serif"],
                    },
                    borderRadius: {
                        DEFAULT: "0.5rem", // 8px
                    },
                },
            },
        };
    </script>

    <style>
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
    </style>
</head>

<body class="font-display bg-background-light dark:bg-background-dark text-gray-800 dark:text-gray-200">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside
            class="w-64 flex-shrink-0 bg-white dark:bg-gray-800 p-6 border-r border-gray-200 dark:border-gray-700 flex flex-col">
            <div class="mb-10">
                <h1 class="text-xl font-bold text-gray-900 dark:text-white">UNO Spicchio</h1>
            </div>

            <nav class="flex flex-col space-y-2 flex-1">
                <div class="px-4 py-3 bg-red-50 dark:bg-gray-700 rounded-lg">
                    <p class="font-semibold text-primary">UNO Spicchio</p>
                </div>

                <a href="active-orders.html"
                    class="block px-4 py-3 bg-red-100/50 dark:bg-gray-700/50 rounded-lg font-medium text-gray-900 dark:text-white">
                    Все заказы
                </a>

                <a id="createOrderLink" href="create-order.html"
                    class="block px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300">
                    Создать заказ
                </a>

                <a id="chefLink" href="chef-orders.html"
                    class="block px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300">
                    Кухня
                </a>
                <a id="dashboardLink" href="dashboard.html"
                    class="block px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300">
                    Аналитика
                </a>
            </nav>
        </aside>

        <!-- Main -->
        <main class="flex-1 flex flex-col">
            <!-- Header -->
            <header
                class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
                <div></div>
                <div class="flex items-center space-x-4">
                    <button onclick="logout()"
                        class="text-sm text-gray-600 dark:text-gray-300 hover:text-primary transition-colors">
                        Выход
                    </button>
                    <img alt="Аватар пользователя" class="h-10 w-10 rounded-full object-cover"
                        src="https://i.pravatar.cc/40" />
                </div>
            </header>

            <!-- Content -->
            <div class="flex-1 p-8 overflow-y-auto">
                <!-- Heading + New order -->
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900 dark:text-white">Активные заказы</h2>
                        <p class="mt-1 text-gray-500 dark:text-gray-400">
                            Просмотр всех текущих заказов в реальном времени
                        </p>
                    </div>
                    <a href="create-order.html" id="newOrderBtn"
                        class="bg-primary hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2 transition-colors">
                        <span class="material-icons" style="font-size: 20px;">add</span>
                        <span>Новый заказ</span>
                    </a>
                </div>

                <!-- Tabs -->
                <div class="border-b border-gray-200 dark:border-gray-700 mb-6">
                    <nav id="tabs" class="flex space-x-8 -mb-px">
                        <a href="#" data-status="all"
                            class="tab-link py-4 px-1 border-b-2 font-medium text-sm text-primary border-primary">
                            Все заказы
                        </a>
                        <a href="#" data-status="new"
                            class="tab-link py-4 px-1 border-b-2 font-medium text-sm text-gray-500 dark:text-gray-400 border-transparent hover:text-gray-700 dark:hover:text-gray-200 hover:border-gray-300 dark:hover:border-gray-600">
                            Новые
                        </a>
                        <a href="#" data-status="in_progress"
                            class="tab-link py-4 px-1 border-b-2 font-medium text-sm text-gray-500 dark:text-gray-400 border-transparent hover:text-gray-700 dark:hover:text-gray-200 hover:border-gray-300 dark:hover:border-gray-600">
                            В процессе
                        </a>
                        <a href="#" data-status="ready"
                            class="tab-link py-4 px-1 border-b-2 font-medium text-sm text-gray-500 dark:text-gray-400 border-transparent hover:text-gray-700 dark:hover:text-gray-200 hover:border-gray-300 dark:hover:border-gray-600">
                            Готово
                        </a>
                    </nav>
                </div>

                <!-- Table -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead
                                class="text-xs text-gray-500 dark:text-gray-400 uppercase bg-gray-50 dark:bg-gray-700/50">
                                <tr>
                                    <th scope="col" class="px-6 py-4 font-medium">Номер</th>
                                    <th scope="col" class="px-6 py-4 font-medium">Стол</th>
                                    <th scope="col" class="px-6 py-4 font-medium">Статус</th>
                                    <th scope="col" class="px-6 py-4 font-medium">Время</th>
                                    <th scope="col" class="px-6 py-4 font-medium">Детали</th>
                                    <th scope="col" class="px-6 py-4 font-medium">Сумма</th>
                                    <th scope="col" class="px-6 py-4 font-medium text-right">Действия</th>
                                </tr>
                            </thead>
                            <tbody id="orders-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Logic (как в исходной странице, чуть подправлены классы строк/колонок) -->
    <script>
        const API_BASE_URL = 'http://localhost:8080/api';
        const ordersTableBody = document.getElementById('orders-table-body');
        const tabsContainer = document.getElementById('tabs');
        let allOrders = [];
        let currentFilter = 'all';
        let currentUser = null;

        function checkAuth() {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                window.location.href = 'login.html';
                return false;
            }
            return token;
        }

        async function loadUserData() {
            const token = checkAuth();
            if (!token) return;

            try {
                const response = await fetch(`${API_BASE_URL}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();

                    if (result.success && result.data) {
                        currentUser = result.data;
                    } else if (result.id) {
                        currentUser = result;
                    }

                    console.log('Current user:', currentUser);

                    if (currentUser) {
                        // Скрываем аналитику для не admin/manager
                        if (currentUser.role !== 'admin' && currentUser.role !== 'manager') {
                            document.getElementById('dashboardLink').style.display = 'none';
                        }

                        // Новый заказ только для официантов и админов
                        if (currentUser.role !== 'waiter' && currentUser.role !== 'admin') {
                            document.getElementById('newOrderBtn').style.display = 'none';
                        }

                        // Кухня только для cook, waiter и admin
                        const chefLink = document.getElementById('chefLink');
                        if (chefLink &&
                            currentUser.role !== 'cook' &&
                            currentUser.role !== 'waiter' &&
                            currentUser.role !== 'admin') {
                            chefLink.style.display = 'none';
                        }
                    }
                } else {
                    logout();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                logout();
            }
        }

        function logout() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_data');
            window.location.href = 'login.html';
        }

        function getStatusInfo(status) {
            switch (status) {
                case 'new':
                    return { text: 'Новый', colorClass: 'bg-blue-100 text-blue-800 dark:bg-blue-900/40 dark:text-blue-200' };
                case 'in_progress':
                    return { text: 'В процессе', colorClass: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/40 dark:text-yellow-200' };
                case 'ready':
                    return { text: 'Готово', colorClass: 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300' };
                case 'paid':
                    return { text: 'Оплачен', colorClass: 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200' };
                default:
                    return { text: status, colorClass: 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200' };
            }
        }

        function formatTimeAgo(dateString) {
            const now = new Date();
            const orderTime = new Date(dateString);
            const diffMs = now - orderTime;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffDays > 0) {
                return `${diffDays} дн. назад`;
            } else if (diffHours > 0) {
                return `${diffHours} ч. ${diffMins % 60} мин. назад`;
            } else if (diffMins > 0) {
                return `${diffMins} мин. назад`;
            } else {
                return 'Только что';
            }
        }

        function formatLocalTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        async function fetchOrderDetails(orderId) {
            const token = checkAuth();
            if (!token) return [];

            try {
                const response = await fetch(`${API_BASE_URL}/orders/${orderId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log(`Order ${orderId} details:`, result);

                    let order;
                    if (result.success && result.data) {
                        order = result.data;
                    } else if (result.id) {
                        order = result;
                    }

                    console.log(`Order ${orderId} items:`, order?.items);
                    return order?.items || [];
                }
            } catch (error) {
                console.error('Error fetching order details:', error);
            }
            return [];
        }

        async function renderOrders() {
            ordersTableBody.innerHTML = '';
            const filteredOrders = allOrders.filter(order => {
                if (currentFilter === 'all') return order.status !== 'paid';
                return order.status === currentFilter;
            });

            if (filteredOrders.length === 0) {
                ordersTableBody.innerHTML = `
          <tr>
            <td colspan="7"
                class="text-center px-6 py-8 text-gray-500 dark:text-gray-400">
              Нет заказов в этой категории.
            </td>
          </tr>`;
                return;
            }

            for (const order of filteredOrders) {
                console.log('Rendering order:', order);

                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer';

                const statusInfo = getStatusInfo(order.status);
                const timeAgo = formatTimeAgo(order.created_at);
                const localTime = formatLocalTime(order.created_at);

                // Детали заказа
                const items = await fetchOrderDetails(order.id);
                const details = items && items.length > 0
                    ? items.map(item => {
                        const dishName = item.dish?.name || item.dish_name || 'Блюдо';
                        return `${dishName} (x${item.qty})`;
                    }).join(', ')
                    : 'Нет деталей';

                // Имя стола
                let tableName = 'Неизвестный стол';
                if (order.table && order.table.name) {
                    tableName = order.table.name;
                } else if (order.table_name) {
                    tableName = order.table_name;
                } else if (order.table_number) {
                    tableName = `Стол #${order.table_number}`;
                }

                // Кнопка "Закрыть"
                let actionButton = '';
                if ((currentUser.role === 'waiter' || currentUser.role === 'admin') && order.status === 'ready') {
                    actionButton = `
            <button
              class="close-order-btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md text-xs transition-colors"
              data-order-id="${order.id}">
              Закрыть
            </button>`;
                }

                tr.innerHTML = `
          <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">#${order.id}</td>
          <td class="px-6 py-4">${tableName}</td>
          <td class="px-6 py-4">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusInfo.colorClass}">
              ${statusInfo.text}
            </span>
          </td>
          <td class="px-6 py-4">
            <div class="text-gray-900 dark:text-white">${timeAgo}</div>
            <div class="text-gray-500 dark:text-gray-400 text-xs">${localTime}</div>
          </td>
          <td class="px-6 py-4 text-gray-700 dark:text-gray-200 truncate max-w-xs" title="${details}">${details}</td>
          <td class="px-6 py-4 font-semibold text-gray-900 dark:text-white">
            ${order.total.toFixed(2)} ₸
          </td>
          <td class="px-6 py-4 text-right">
            ${actionButton}
          </td>
        `;
                ordersTableBody.appendChild(tr);
            }

            // Обработчики кнопок закрытия
            document.querySelectorAll('.close-order-btn').forEach(btn => {
                btn.addEventListener('click', handleCloseOrder);
            });
        }

        async function fetchOrders() {
            const token = checkAuth();
            if (!token) return;

            try {
                const response = await fetch(`${API_BASE_URL}/orders`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Orders API response:', result);

                    if (result.success && result.data) {
                        allOrders = result.data;
                    } else if (Array.isArray(result)) {
                        allOrders = result;
                    } else {
                        allOrders = [];
                    }

                    console.log('Parsed orders:', allOrders);
                    await renderOrders();
                } else if (response.status === 401) {
                    logout();
                } else {
                    const errorText = await response.text();
                    console.error('Ошибка при загрузке заказов:', response.status, errorText);
                }
            } catch (error) {
                console.error('Не удалось подключиться к серверу:', error);
                ordersTableBody.innerHTML = `
          <tr>
            <td colspan="7"
                class="text-center px-6 py-8 text-red-600 dark:text-red-400">
              Не удалось загрузить данные.
            </td>
          </tr>`;
            }
        }

        // Tabs
        tabsContainer.addEventListener('click', (event) => {
            const clickedTab = event.target.closest('.tab-link');
            if (!clickedTab) return;
            event.preventDefault();

            tabsContainer.querySelectorAll('.tab-link').forEach(tab => {
                tab.classList.remove('text-primary', 'border-primary');
                tab.classList.add('text-gray-500', 'dark:text-gray-400', 'border-transparent');
            });

            clickedTab.classList.add('text-primary', 'border-primary');
            clickedTab.classList.remove('text-gray-500', 'dark:text-gray-400', 'border-transparent');

            currentFilter = clickedTab.dataset.status;
            renderOrders();
        });

        async function handleCloseOrder(event) {
            const orderId = parseInt(event.target.dataset.orderId);
            if (!orderId) return;

            if (!confirm('Закрыть заказ и освободить стол?')) return;

            const token = checkAuth();
            if (!token) return;

            try {
                const response = await fetch(`${API_BASE_URL}/orders/${orderId}/close`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    alert('Заказ успешно закрыт!');
                    await fetchOrders();
                } else {
                    const errorData = await response.json();
                    alert('Ошибка: ' + (errorData.error || response.statusText));
                }
            } catch (error) {
                console.error('Error closing order:', error);
                alert('Ошибка сети');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadUserData();
            fetchOrders();
            // автообновление каждые 30 секунд
            setInterval(fetchOrders, 30000);
        });
    </script>
</body>

</html>