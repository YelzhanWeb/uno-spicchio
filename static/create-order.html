<!DOCTYPE html>
<html class="light" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>UNO Spicchio - –ù–æ–≤—ã–π –∑–∞–∫–∞–∑</title>

    <!-- –®—Ä–∏—Ñ—Ç—ã -->
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#ec2513",
                        "background-light": "#f8f6f6",
                        "background-dark": "#221210",
                    },
                    fontFamily: {
                        display: ["Work Sans", "sans-serif"],
                    },
                    borderRadius: {
                        DEFAULT: "0.25rem",
                        lg: "0.5rem",
                        xl: "0.75rem",
                        full: "9999px",
                    },
                },
            },
        };
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            font-size: 24px;
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark font-display">
    <div class="relative flex min-h-screen w-full">
        <!-- Sidebar -->
        <aside
            class="flex flex-col w-64 p-4 border-r border-[#e7d1cf] dark:border-white/10 bg-background-light dark:bg-background-dark text-[#1b0f0d] dark:text-gray-200">
            <div class="flex flex-col gap-4">
                <div class="flex items-center gap-3">
                    <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10"
                        data-alt="UNO Spicchio restaurant logo"
                        style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuCej6nzjOCtkOZnCO4ii1a233pgbYET5xcmiLDmPTeymtIJXUvI6lUMJ6uDMvSeLIpITQpAFUy-Zr4OsEN0Fltm3l88JmjT4eTT3wZuBVnZKXvMuR__hvoasQRRRlj_s3PyAqDUAfuGgXRDIc5kWHYO9jZ3M9LtlQmNCt06Bjo0p2vBW3bYBWadqc2rC7VBJEPCghP_fS4Nig3vr-5CZu-Ij4it-l7EE_R0ZCF1M2ZoqJwrph4MuZ5IRZHu-EDQHEu0rnpGkrQdRz4");'>
                    </div>
                    <div class="flex flex-col">
                        <h1 class="text-base font-medium leading-normal text-[#1b0f0d] dark:text-white">
                            UNO Spicchio
                        </h1>
                        <p class="text-sm font-normal leading-normal text-gray-500 dark:text-gray-400">
                            Admin Panel
                        </p>
                    </div>
                </div>
                <nav class="flex flex-col gap-2 mt-4">
                    <a href="dashboard.html"
                        class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/10 dark:hover:bg-primary/20">
                        <span class="material-symbols-outlined">dashboard</span>
                        <p class="text-sm font-medium leading-normal">Dashboard</p>
                    </a>
                    <a href="active-orders.html"
                        class="flex items-center gap-3 px-3 py-2 rounded-lg bg-primary/20 dark:bg-primary/30 text-primary dark:text-[#f8f6f6]">
                        <span class="material-symbols-outlined"
                            style="font-variation-settings: 'FILL' 1;">receipt_long</span>
                        <p class="text-sm font-medium leading-normal">Orders</p>
                    </a>
                    <!-- –ü–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∏, –º–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –ø–æ–∑–∂–µ -->
                    <a href="#"
                        class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/10 dark:hover:bg-primary/20">
                        <span class="material-symbols-outlined">restaurant_menu</span>
                        <p class="text-sm font-medium leading-normal">Menu</p>
                    </a>
                    <a href="#"
                        class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/10 dark:hover:bg-primary/20">
                        <span class="material-symbols-outlined">table_restaurant</span>
                        <p class="text-sm font-medium leading-normal">Reservations</p>
                    </a>
                    <a href="#"
                        class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/10 dark:hover:bg-primary/20">
                        <span class="material-symbols-outlined">settings</span>
                        <p class="text-sm font-medium leading-normal">Settings</p>
                    </a>
                </nav>
            </div>
            <div class="flex flex-col gap-4 mt-auto">
                <button type="button"
                    class="flex items-center justify-center w-full h-10 px-4 text-sm font-bold tracking-wider rounded-lg cursor-pointer bg-primary text-white">
                    <span class="truncate">NEW ORDER</span>
                </button>
                <div class="flex flex-col gap-1">
                    <a href="#"
                        class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/10 dark:hover:bg-primary/20">
                        <span class="material-symbols-outlined">help_outline</span>
                        <p class="text-sm font-medium leading-normal">Help</p>
                    </a>
                    <a href="#" onclick="logout(); return false;"
                        class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/10 dark:hover:bg-primary/20">
                        <span class="material-symbols-outlined">logout</span>
                        <p class="text-sm font-medium leading-normal">Log Out</p>
                    </a>
                </div>
            </div>
        </aside>

        <!-- Main content -->
        <main class="flex-1 p-8 overflow-y-auto">
            <div class="max-w-7xl mx-auto">
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
                <div class="flex flex-wrap items-center justify-between gap-3 mb-8">
                    <p class="text-[#1b0f0d] dark:text-white text-4xl font-black tracking-tighter">
                        Create New Order
                    </p>
                </div>

                <!-- –î–≤–µ –∫–æ–ª–æ–Ω–∫–∏ -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ (—Å—Ç–æ–ª + –∑–∞–∫–∞–∑) -->
                    <div class="lg:col-span-1 flex flex-col gap-6">
                        <!-- –í—ã–±–æ—Ä —Å—Ç–æ–ª–∞ -->
                        <div class="flex flex-col w-full">
                            <label class="flex flex-col w-full">
                                <p class="text-[#1b0f0d] dark:text-gray-200 text-base font-medium leading-normal pb-2">
                                    Select Table
                                </p>
                                <select id="table-select"
                                    class="form-select flex w-full min-w-0 resize-none overflow-hidden rounded-lg text-[#1b0f0d] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#e7d1cf] dark:border-white/20 bg-background-light dark:bg-background-dark focus:border-primary h-14 placeholder:text-gray-400 p-3 text-base font-normal leading-normal">
                                    <option value="">Loading tables...</option>
                                </select>
                            </label>
                        </div>

                        <!-- –¢–µ–∫—É—â–∏–π –∑–∞–∫–∞–∑ -->
                        <div class="flex flex-col">
                            <h3 class="text-[#1b0f0d] dark:text-white text-lg font-bold tracking-tight pb-2 pt-4">
                                Current Order
                            </h3>
                            <div
                                class="flex flex-col p-4 bg-white/50 dark:bg-white/5 rounded-xl border border-[#e7d1cf] dark:border-white/10">
                                <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–æ–∑–∏—Ü–∏–π –∑–∞–∫–∞–∑–∞ -->
                                <div id="order-items-container" class="flex flex-col gap-3">
                                    <!-- JS —Å–∞–º –≤—Å—Ç–∞–≤–∏—Ç —Å—é–¥–∞ –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–ª–∏ —Å–ø–∏—Å–æ–∫ –ø–æ–∑–∏—Ü–∏–π -->
                                </div>

                                <!-- –ò—Ç–æ–≥ -->
                                <div
                                    class="flex flex-col gap-2 pt-4 mt-4 border-t border-dashed border-[#e7d1cf] dark:border-white/10">
                                    <div
                                        class="flex justify-between items-center text-sm text-gray-600 dark:text-gray-300">
                                        <span>Subtotal</span>
                                        <span id="order-subtotal">‚Ç∏0.00</span>
                                    </div>
                                    <div
                                        class="flex justify-between items-center text-lg font-bold text-[#1b0f0d] dark:text-white">
                                        <span>Total</span>
                                        <span id="order-total">‚Ç∏0.00</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ -->
                        <button id="create-order-btn" type="button"
                            class="flex items-center justify-center w-full h-12 px-4 mt-auto text-base font-bold tracking-wider text-white rounded-lg cursor-pointer bg-primary hover:opacity-90 disabled:opacity-50">
                            <span class="truncate">CREATE ORDER</span>
                        </button>
                    </div>

                    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ (–º–µ–Ω—é) -->
                    <div class="lg:col-span-2 flex flex-col gap-6">
                        <!-- –ü–æ–∏—Å–∫ -->
                        <div class="relative">
                            <span
                                class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
                            <input id="menu-search" type="text"
                                class="w-full h-14 pl-12 pr-4 text-base rounded-lg border border-[#e7d1cf] dark:border-white/20 bg-background-light dark:bg-background-dark focus:ring-2 focus:ring-primary/50 focus:border-primary text-[#1b0f0d] dark:text-white placeholder:text-gray-400"
                                placeholder="Search menu items..." />
                        </div>

                        <!-- –¢–∞–±—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
                        <div class="border-b border-[#e7d1cf] dark:border-white/10">
                            <nav id="menu-tabs-container" aria-label="Tabs" class="flex -mb-px space-x-6">
                                <!-- JS —Å–∞–º –æ—Ç—Ä–∏—Å—É–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
                            </nav>
                        </div>

                        <!-- –°–µ—Ç–∫–∞ –±–ª—é–¥ -->
                        <div id="menu-items-container" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6">
                            <!-- JS —Å–∞–º –≤—Å—Ç–∞–≤–∏—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ –±–ª—é–¥ -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- –õ–û–ì–ò–ö–ê –ò–ó –¢–í–û–ï–ì–û –†–ê–ë–û–¢–ê–Æ–©–ï–ì–û –í–ê–†–ò–ê–ù–¢–ê -->
    <script>
        const API_BASE_URL = 'http://localhost:8080/api';
        let menuData = [];
        let currentOrder = { items: new Map() };
        let activeCategoryId = null;
        let currentUser = null;
        let tables = [];
        let menuSearchTerm = '';

        const menuTabsContainer = document.getElementById('menu-tabs-container');
        const menuItemsContainer = document.getElementById('menu-items-container');
        const orderItemsContainer = document.getElementById('order-items-container');
        const orderSubtotalEl = document.getElementById('order-subtotal');
        const orderTotalEl = document.getElementById('order-total');
        const createOrderBtn = document.getElementById('create-order-btn');
        const tableSelect = document.getElementById('table-select');
        const menuSearchInput = document.getElementById('menu-search');

        function checkAuth() {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                window.location.href = 'login.html';
                return false;
            }
            return token;
        }

        async function loadUserData() {
            const token = checkAuth();
            if (!token) return;

            try {
                const response = await fetch(`${API_BASE_URL}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const result = await response.json();

                    if (result.success && result.data) {
                        currentUser = result.data;
                    } else if (result.id) {
                        currentUser = result;
                    }

                    if (currentUser) {
                        // –í —Å—Ç–∞—Ä–æ–º –∫–æ–¥–µ —Å–∫—Ä—ã–≤–∞–ª—Å—è dashboardLink ‚Äì –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø. –ª–æ–≥–∏–∫—É –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏
                        if (currentUser.role !== 'waiter' && currentUser.role !== 'admin') {
                            alert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤');
                            window.location.href = 'active-orders.html';
                        }
                    }
                } else {
                    logout();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                logout();
            }
        }

        function logout() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_data');
            window.location.href = 'login.html';
        }

        async function loadTables() {
            const token = checkAuth();
            if (!token) return;

            try {
                const response = await fetch(`${API_BASE_URL}/tables`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const result = await response.json();

                    if (result.success && result.data) {
                        tables = result.data;
                    } else if (Array.isArray(result)) {
                        tables = result;
                    } else {
                        tables = [];
                    }

                    tableSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ–ª</option>';
                    tables.forEach(table => {
                        const option = document.createElement('option');
                        option.value = table.id;
                        let statusText = table.status === 'free' ? 'üü¢ –°–≤–æ–±–æ–¥–µ–Ω' :
                            table.status === 'reserve' ? 'üü° –ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω' :
                                'üî¥ –ó–∞–Ω—è—Ç';
                        option.textContent = `${table.name} - ${statusText}`;
                        option.disabled = table.status === 'busy';
                        tableSelect.appendChild(option);
                    });
                } else {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–æ–ª–æ–≤');
                }
            } catch (error) {
                console.error('Error loading tables:', error);
            }
        }

        async function loadMenu() {
            const token = checkAuth();
            if (!token) return;

            try {
                const categoriesResponse = await fetch(`${API_BASE_URL}/categories`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!categoriesResponse.ok) {
                    throw new Error('Failed to load categories');
                }

                const categoriesResult = await categoriesResponse.json();
                let categories;

                if (categoriesResult.success && categoriesResult.data) {
                    categories = categoriesResult.data;
                } else if (Array.isArray(categoriesResult)) {
                    categories = categoriesResult;
                } else {
                    categories = [];
                }

                const dishesResponse = await fetch(`${API_BASE_URL}/dishes?active=true`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!dishesResponse.ok) {
                    throw new Error('Failed to load dishes');
                }

                const dishesResult = await dishesResponse.json();
                let dishes;

                if (dishesResult.success && dishesResult.data) {
                    dishes = dishesResult.data;
                } else if (Array.isArray(dishesResult)) {
                    dishes = dishesResult;
                } else {
                    dishes = [];
                }

                menuData = categories.map(category => ({
                    id: category.id,
                    name: category.name,
                    dishes: dishes.filter(dish => dish.category_id === category.id && dish.is_active)
                }));

                if (menuData.length > 0) {
                    activeCategoryId = menuData[0].id;
                    renderTabs();
                    renderMenu();
                } else {
                    menuItemsContainer.innerHTML =
                        '<p class="text-gray-500 p-4">–ú–µ–Ω—é –ø—É—Å—Ç–æ.</p>';
                }
            } catch (error) {
                console.error('Error loading menu:', error);
                menuItemsContainer.innerHTML =
                    '<p class="text-red-500 p-4">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω—é.</p>';
            }
        }

        function renderTabs() {
            menuTabsContainer.innerHTML = '';
            menuData.forEach(category => {
                const isActive = category.id === activeCategoryId;
                const tab = document.createElement('a');
                tab.href = '#';
                tab.className =
                    `px-1 py-3 text-sm font-semibold border-b-2 whitespace-nowrap ` +
                    (isActive
                        ? 'border-primary text-primary'
                        : 'text-gray-500 border-transparent dark:text-gray-400 hover:text-primary hover:border-primary/50');
                tab.textContent = category.name;
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    activeCategoryId = category.id;
                    renderTabs();
                    renderMenu();
                });
                menuTabsContainer.appendChild(tab);
            });
        }

        function renderMenu() {
            menuItemsContainer.innerHTML = '';
            const activeCategory = menuData.find(c => c.id === activeCategoryId);
            if (!activeCategory || !activeCategory.dishes || activeCategory.dishes.length === 0) {
                menuItemsContainer.innerHTML =
                    '<p class="text-gray-500 p-4">–í —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ—Ç –±–ª—é–¥.</p>';
                return;
            }

            const dishesToRender = activeCategory.dishes.filter(dish => {
                if (!menuSearchTerm) return true;
                const text = `${dish.name} ${dish.description || ''}`.toLowerCase();
                return text.includes(menuSearchTerm);
            });

            if (dishesToRender.length === 0) {
                menuItemsContainer.innerHTML =
                    '<p class="text-gray-500 p-4">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É.</p>';
                return;
            }

            dishesToRender.forEach(dish => {
                const card = document.createElement('div');
                card.className =
                    'flex flex-col bg-white/50 dark:bg-white/5 rounded-xl border border-[#e7d1cf] dark:border-white/10 overflow-hidden';

                // –ï—Å–ª–∏ –≤ API –Ω–µ—Ç –∫–∞—Ä—Ç–∏–Ω–æ–∫, –º–æ–∂–Ω–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å <img> –≤–æ–æ–±—â–µ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–∞–≥–ª—É—à–∫—É
                const imageUrl = dish.image_url || '';
                const hasImage = Boolean(imageUrl);

                card.innerHTML = `
                    ${hasImage
                        ? `<img class="w-full h-40 object-cover" src="${imageUrl}" alt="${dish.name}"/>`
                        : ''
                    }
                    <div class="p-4 flex flex-col flex-1">
                        <div class="flex-1">
                            <h4 class="font-bold text-lg text-[#1b0f0d] dark:text-white">${dish.name}</h4>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                                ${dish.description || ''}
                            </p>
                        </div>
                        <div class="flex justify-between items-center mt-4">
                            <p class="font-bold text-lg text-[#1b0f0d] dark:text-white">
                                ‚Ç∏${dish.price.toFixed(2)}
                            </p>
                            <button
                                class="add-dish-btn flex items-center justify-center h-9 px-4 text-sm font-bold tracking-wide rounded-lg cursor-pointer bg-primary/20 dark:bg-primary/30 text-primary dark:text-[#f8f6f6] hover:bg-primary/30 dark:hover:bg-primary/40">
                                Add
                            </button>
                        </div>
                    </div>
                `;

                card.querySelector('.add-dish-btn')
                    .addEventListener('click', () => addToOrder(dish));

                menuItemsContainer.appendChild(card);
            });
        }

        function renderCurrentOrder() {
            orderItemsContainer.innerHTML = '';

            if (currentOrder.items.size === 0) {
                orderItemsContainer.innerHTML = `
                    <div class="flex flex-col items-center gap-4 py-10 text-center">
                        <p class="text-lg font-bold leading-tight tracking-tight text-[#1b0f0d] dark:text-white">
                            No items added yet
                        </p>
                        <p class="text-sm font-normal leading-normal text-gray-500 dark:text-gray-400 max-w-xs">
                            Select items from the menu to add them to this order.
                        </p>
                    </div>
                `;
                updateTotals();
                return;
            }

            currentOrder.items.forEach(item => {
                const row = document.createElement('div');
                row.className = 'flex items-center justify-between py-2 border-b border-[#e7d1cf]/80 last:border-b-0';

                const itemTotal = item.price * item.quantity;

                row.innerHTML = `
                    <div class="flex flex-col">
                        <p class="text-sm font-medium text-[#1b0f0d] dark:text-white">${item.name}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">
                            –¶–µ–Ω–∞: ‚Ç∏${item.price.toFixed(2)}
                        </p>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="flex items-center justify-center gap-2">
                            <button class="decrement-btn text-lg font-bold text-red-500 hover:text-red-700">-</button>
                            <span class="min-w-[20px] text-center text-sm">${item.quantity}</span>
                            <button class="increment-btn text-lg font-bold text-green-500 hover:text-green-700">+</button>
                        </div>
                        <p class="text-sm font-semibold text-[#1b0f0d] dark:text-white">
                            ‚Ç∏${itemTotal.toFixed(2)}
                        </p>
                    </div>
                `;

                row.querySelector('.decrement-btn')
                    .addEventListener('click', () => decrementItem(item.dish_id));
                row.querySelector('.increment-btn')
                    .addEventListener('click', () => incrementItem(item.dish_id));

                orderItemsContainer.appendChild(row);
            });

            updateTotals();
        }

        function updateTotals() {
            let subtotal = 0;
            currentOrder.items.forEach(item => {
                subtotal += item.price * item.quantity;
            });
            orderSubtotalEl.textContent = `‚Ç∏${subtotal.toFixed(2)}`;
            orderTotalEl.textContent = `‚Ç∏${subtotal.toFixed(2)}`;
        }

        function addToOrder(dish) {
            if (currentOrder.items.has(dish.id)) {
                incrementItem(dish.id);
            } else {
                currentOrder.items.set(dish.id, {
                    dish_id: dish.id,
                    name: dish.name,
                    price: dish.price,
                    quantity: 1
                });
            }
            renderCurrentOrder();
        }

        function incrementItem(dishId) {
            if (currentOrder.items.has(dishId)) {
                currentOrder.items.get(dishId).quantity++;
                renderCurrentOrder();
            }
        }

        function decrementItem(dishId) {
            if (currentOrder.items.has(dishId)) {
                const item = currentOrder.items.get(dishId);
                item.quantity--;
                if (item.quantity === 0) {
                    currentOrder.items.delete(dishId);
                }
                renderCurrentOrder();
            }
        }

        async function submitOrder() {
            if (currentOrder.items.size === 0) {
                alert('–ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å –ø—É—Å—Ç–æ–π –∑–∞–∫–∞–∑.');
                return;
            }

            const tableNumber = parseInt(tableSelect.value);
            if (!tableNumber) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ–ª.');
                return;
            }

            const token = checkAuth();
            if (!token) return;

            const payload = {
                table_number: tableNumber,
                notes: null,
                items: Array.from(currentOrder.items.values()).map(item => ({
                    dish_id: item.dish_id,
                    qty: item.quantity,
                    notes: null
                }))
            };

            console.log('Sending order:', payload);

            createOrderBtn.disabled = true;
            createOrderBtn.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ...';

            try {
                const response = await fetch(`${API_BASE_URL}/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    alert('–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
                    window.location.href = 'active-orders.html';
                } else {
                    const errorData = await response.json();
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞: ' + (errorData.error || response.statusText));
                    createOrderBtn.disabled = false;
                    createOrderBtn.textContent = 'CREATE ORDER';
                }
            } catch (error) {
                alert('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞. –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑.');
                console.error(error);
                createOrderBtn.disabled = false;
                createOrderBtn.textContent = 'CREATE ORDER';
            }
        }

        createOrderBtn.addEventListener('click', submitOrder);

        if (menuSearchInput) {
            menuSearchInput.addEventListener('input', (e) => {
                menuSearchTerm = e.target.value.toLowerCase();
                renderMenu();
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await loadUserData();
            await loadTables();
            await loadMenu();
            renderCurrentOrder();
        });
    </script>
</body>

</html>