<!DOCTYPE html>
<html class="light" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>UNO Spicchio - Dashboard</title>

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

    <!-- Inter + Material Symbols -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@100..700,0..1&display=swap"
        rel="stylesheet" />

    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#d32f2f",
                        "background-light": "#f5f5f5",
                        "background-dark": "#1a1a1a",
                        "surface-light": "#ffffff",
                        "surface-dark": "#2a2a2a",
                        "text-primary-light": "#333333",
                        "text-primary-dark": "#e0e0e0",
                        "text-secondary-light": "#666666",
                        "text-secondary-dark": "#b3b3b3",
                        "border-light": "#e0e0e0",
                        "border-dark": "#444444",
                        positive: "#4caf50",
                    },
                    fontFamily: {
                        display: ["Inter", "sans-serif"],
                    },
                    borderRadius: {
                        lg: "0.75rem",
                        xl: "1rem",
                    },
                },
            },
        };
    </script>

    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .material-symbols-outlined.fill {
            font-variation-settings: 'FILL' 1;
        }

        .chart-bar {
            transition: width 0.3s ease-in-out;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>

<body
    class="font-display bg-background-light dark:bg-background-dark text-text-primary-light dark:text-text-primary-dark">
    <div class="relative flex min-h-screen w-full">
        <!-- Sidebar -->
        <aside
            class="flex flex-col w-64 bg-surface-light dark:bg-surface-dark border-r border-border-light dark:border-border-dark p-4 shrink-0">
            <div class="flex flex-col gap-8 h-full">
                <!-- Brand -->
                <div class="flex items-center gap-3">
                    <span
                        class="material-symbols-outlined fill text-primary text-3xl bg-primary/10 rounded-full p-2 flex items-center justify-center">
                        pie_chart
                    </span>
                    <div class="flex flex-col">
                        <h1 class="text-base font-bold">UNO Spicchio</h1>
                        <p class="text-sm text-text-secondary-light dark:text-text-secondary-dark">Admin Panel</p>
                    </div>
                </div>

                <!-- Nav -->
                <nav class="flex flex-col space-y-2 flex-1">
                    <div class="px-4 py-3 bg-red-50 dark:bg-gray-700 rounded-lg">
                        <p class="font-semibold text-primary">UNO Spicchio</p>
                    </div>

                    <a href="active-orders.html"
                        class="block px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300">
                        Все заказы
                    </a>

                    <a id="createOrderLink" href="create-order.html"
                        class="block px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300">
                        Создать заказ
                    </a>

                    <a id="chefLink" href="chef-orders.html"
                        class="block px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300">
                        Кухня
                    </a>
                    <a id="dashboardLink" href="dashboard.html"
                        class="block px-4 py-3 bg-red-100/50 dark:bg-gray-700/50 rounded-lg font-medium text-gray-900 dark:text-white">
                        Аналитика
                    </a>
                </nav>

                <!-- User + logout -->
                <div class="mt-auto pt-4 border-t border-border-light dark:border-border-dark flex flex-col gap-3">
                    <div class="flex items-center gap-3">
                        <img alt="User avatar" class="w-10 h-10 rounded-full object-cover"
                            src="https://i.pravatar.cc/40" />
                        <div>
                            <p class="font-semibold text-sm" id="userFullName">Loading...</p>
                            <p class="text-xs text-text-secondary-light dark:text-text-secondary-dark" id="userRole">...
                            </p>
                        </div>
                    </div>
                    <button onclick="logout()"
                        class="w-full px-4 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors text-left">
                        Выйти
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-8 overflow-y-auto">
            <div class="max-w-7xl mx-auto flex flex-col gap-8" id="dashboardContent">
                <!-- Header + Period buttons + Dark toggle -->
                <div class="flex flex-wrap justify-between items-start gap-4">
                    <div class="flex flex-col gap-2">
                        <p class="text-3xl md:text-4xl font-black tracking-tight">Reports Dashboard</p>
                        <p class="text-base text-text-secondary-light dark:text-text-secondary-dark">
                            Buona giornata! Here's your restaurant's performance overview.
                        </p>
                    </div>
                    <div class="flex items-center gap-4">
                        <!-- Segmented period buttons -->
                        <div
                            class="flex h-10 items-center justify-center rounded-lg bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark p-1 shadow-sm">
                            <button id="btnYesterday" onclick="loadDashboard('yesterday')"
                                class="px-4 h-full text-sm font-medium rounded-md text-text-primary-light dark:text-text-primary-dark hover:bg-black/5 dark:hover:bg-white/5">
                                Yesterday
                            </button>
                            <button id="btnToday" onclick="loadDashboard('today')"
                                class="px-4 h-full text-sm font-medium rounded-md bg-primary text-white">
                                Today
                            </button>
                            <button id="btnCurrentMonth" onclick="loadDashboard('current_month')"
                                class="px-4 h-full text-sm font-medium rounded-md text-text-primary-light dark:text-text-primary-dark hover:bg-black/5 dark:hover:bg-white/5">
                                Current Month
                            </button>
                        </div>

                        <!-- Dark mode toggle -->
                        <button id="darkModeToggle"
                            class="p-2 rounded-full bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark hover:bg-black/5 dark:hover:bg-white/5">
                            <span
                                class="material-symbols-outlined text-text-secondary-light dark:text-text-secondary-dark">
                                dark_mode
                            </span>
                        </button>
                    </div>
                </div>

                <!-- Key Metrics -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div
                        class="flex flex-col gap-2 rounded-xl p-6 bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark">
                        <p class="text-base font-medium text-text-secondary-light dark:text-text-secondary-dark">
                            Total Revenue
                        </p>
                        <p class="text-3xl font-bold" id="totalRevenue">$0</p>
                        <p id="revenueChange"
                            class="text-sm text-text-secondary-light dark:text-text-secondary-dark mt-1">--</p>
                    </div>

                    <div
                        class="flex flex-col gap-2 rounded-xl p-6 bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark">
                        <p class="text-base font-medium text-text-secondary-light dark:text-text-secondary-dark">
                            Total Orders
                        </p>
                        <p class="text-3xl font-bold" id="totalOrders">0</p>
                        <p id="ordersChange"
                            class="text-sm text-text-secondary-light dark:text-text-secondary-dark mt-1">--</p>
                    </div>

                    <div
                        class="flex flex-col gap-2 rounded-xl p-6 bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark">
                        <p class="text-base font-medium text-text-secondary-light dark:text-text-secondary-dark">
                            Average Order Value
                        </p>
                        <p class="text-3xl font-bold" id="avgOrderValue">$0</p>
                        <p id="avgValueChange"
                            class="text-sm text-text-secondary-light dark:text-text-secondary-dark mt-1">--</p>
                    </div>
                </div>

                <!-- Charts & Popular Dishes -->
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                    <!-- Sales by Category (оставлено по структуре как было) -->
                    <div
                        class="lg:col-span-3 bg-surface-light dark:bg-surface-dark p-6 rounded-xl border border-border-light dark:border-border-dark">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Sales by Category</h3>
                        </div>
                        <div id="categorySales" class="flex-1 flex flex-col space-y-4">
                            <!-- Заполняется JS -->
                        </div>
                    </div>

                    <!-- Popular Dishes (оставлено по структуре как было) -->
                    <div
                        class="lg:col-span-2 bg-surface-light dark:bg-surface-dark p-6 rounded-xl border border-border-light dark:border-border-dark">
                        <h3 class="text-lg font-semibold mb-4">Popular Dishes</h3>
                        <ul id="popularDishes" class="space-y-4">
                            <!-- Заполняется JS -->
                        </ul>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8080/api';
        let currentPeriod = 'today';
        let authToken = '';
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            setupEventListeners();
        });

        function checkAuth() {
            authToken = localStorage.getItem('auth_token');
            if (!authToken) {
                window.location.href = 'login.html';
                return;
            }
            loadUserInfo();
            loadDashboard('today');
        }

        function logout() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_data');
            window.location.href = 'login.html';
        }

        async function loadUserInfo() {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();

                    if (result.success && result.data) {
                        currentUser = result.data;
                    } else if (result.id) {
                        currentUser = result;
                    }

                    if (currentUser) {
                        document.getElementById('userFullName').textContent = currentUser.username;
                        document.getElementById('userRole').textContent = currentUser.role;

                        // Управление видимостью ссылок
                        if (currentUser.role !== 'waiter' && currentUser.role !== 'admin') {
                            document.getElementById('createOrderLink').style.display = 'none';
                        }

                        // Показываем ссылку на кухню для cook, waiter и admin
                        const chefLink = document.getElementById('chefLink');
                        if (chefLink && currentUser.role !== 'cook' && currentUser.role !== 'waiter' && currentUser.role !== 'admin') {
                            chefLink.style.display = 'none';
                        }

                        if (currentUser.role !== 'admin' && currentUser.role !== 'manager') {
                            alert('У вас нет прав для просмотра аналитики');
                            window.location.href = 'active-orders.html';
                        }
                    }
                } else {
                    logout();
                }
            } catch (error) {
                console.error('Error loading user info:', error);
                logout();
            }
        }

        async function loadDashboard(period) {
            currentPeriod = period;
            updatePeriodButtons();
            showLoading();

            try {
                const response = await fetch(`${API_BASE_URL}/analytics/dashboard?period=${period}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    let data;
                    if (result.success && result.data) {
                        data = result.data;
                    } else if (result.summary) {
                        data = result;
                    } else {
                        console.error('Invalid data format:', result);
                        showError('Invalid dashboard data format');
                        return;
                    }

                    updateDashboard(data);
                } else {
                    const errorText = await response.text();
                    console.error('Failed to load dashboard:', response.status, errorText);
                    showError('Failed to load dashboard data: ' + response.status);
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showError('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function updateDashboard(data) {
            const summary = data.summary || {};
            const categorySales = data.category_sales || [];
            const popularDishes = data.popular_dishes || [];

            updateSummary(summary);
            updateCategorySales(categorySales);
            updatePopularDishes(popularDishes);
        }

        function updateSummary(summary) {
            const totalRevenue = summary.total_revenue || 0;
            const totalOrders = summary.total_orders || 0;
            const avgOrderValue = summary.average_order_value || 0;

            document.getElementById('totalRevenue').textContent = totalRevenue.toFixed(2) + ' ₸';
            document.getElementById('totalOrders').textContent = totalOrders;
            document.getElementById('avgOrderValue').textContent = avgOrderValue.toFixed(2) + ' ₸';

            updateChangeIndicator('revenueChange', summary.revenue_change || 0);
            updateChangeIndicator('ordersChange', summary.orders_change || 0);
            updateChangeIndicator('avgValueChange', summary.avg_value_change || 0);
        }

        function updateChangeIndicator(elementId, change) {
            const element = document.getElementById(elementId);
            const isPositive = change >= 0;
            const className = isPositive
                ? 'text-sm font-medium text-positive mt-1 flex items-center gap-1'
                : 'text-sm font-medium text-red-500 mt-1 flex items-center gap-1';

            element.className = className;
            element.textContent = `${isPositive ? '+' : ''}${change.toFixed(1)}% from last period`;
        }

        // --- Sales by Category (горизонтальные бары как на скрине) ---
        function updateCategorySales(sales) {
            const container = document.getElementById('categorySales');

            const barColors = [
                'bg-red-500',
                'bg-emerald-500',
                'bg-blue-500',
                'bg-amber-500',
                'bg-violet-500',
                'bg-orange-500'
            ];

            if (!sales || sales.length === 0) {
                container.innerHTML =
                    '<p class="text-text-secondary-light dark:text-text-secondary-dark">No sales data available for this period</p>';
                return;
            }

            container.innerHTML = sales.map((sale, index) => {
                const barColorClass = barColors[index % barColors.length];
                const percentage = sale.percentage || 0;
                const revenue = sale.revenue || 0;

                return `
          <div class="flex items-center gap-4">
            <div class="w-32 text-sm text-text-secondary-light dark:text-text-secondary-dark truncate">
              ${sale.category_name}
            </div>
            <div class="flex-1 bg-slate-800/90 dark:bg-slate-800 rounded-full h-3">
              <div class="${barColorClass} h-3 rounded-full chart-bar" style="width: ${Math.min(percentage, 100)}%;"></div>
            </div>
            <div class="w-24 text-right">
              <div class="font-semibold">${revenue.toFixed(0)} ₸</div>
              <div class="text-xs text-text-secondary-light dark:text-text-secondary-dark">${percentage.toFixed(1)}%</div>
            </div>
          </div>
        `;
            }).join('');
        }

        // --- Popular Dishes (иконки + текст как на скрине) ---
        function updatePopularDishes(dishes) {
            const container = document.getElementById('popularDishes');

            const dishStyles = [
                { icon: 'local_pizza', bg: 'bg-red-100', bgDark: 'dark:bg-red-900/30', text: 'text-red-500' },
                { icon: 'ramen_dining', bg: 'bg-emerald-100', bgDark: 'dark:bg-emerald-900/30', text: 'text-emerald-500' },
                { icon: 'tapas', bg: 'bg-blue-100', bgDark: 'dark:bg-blue-900/30', text: 'text-blue-500' },
                { icon: 'cake', bg: 'bg-amber-100', bgDark: 'dark:bg-amber-900/30', text: 'text-amber-500' },
                { icon: 'local_bar', bg: 'bg-orange-100', bgDark: 'dark:bg-orange-900/30', text: 'text-orange-500' }
            ];

            if (!dishes || dishes.length === 0) {
                container.innerHTML =
                    '<p class="text-text-secondary-light dark:text-text-secondary-dark">No popular dishes data available for this period</p>';
                return;
            }

            container.innerHTML = dishes.map((dish, index) => {
                const style = dishStyles[index % dishStyles.length];
                const revenue = dish.revenue || 0;
                const qtySold = dish.qty_sold || 0;

                return `
          <li class="flex items-center">
            <div class="w-10 h-10 ${style.bg} ${style.bgDark} rounded-full flex items-center justify-center mr-4">
              <span class="material-symbols-outlined ${style.text}">${style.icon}</span>
            </div>
            <div class="flex-1">
              <span class="font-medium">${dish.dish_name}</span>
              <p class="text-sm text-text-secondary-light dark:text-text-secondary-dark">${qtySold} sold</p>
            </div>
            <span class="font-semibold">${revenue.toFixed(0)} ₸</span>
          </li>
        `;
            }).join('');
        }

        function updatePeriodButtons() {
            const buttons = {
                'yesterday': 'btnYesterday',
                'today': 'btnToday',
                'current_month': 'btnCurrentMonth'
            };

            Object.entries(buttons).forEach(([period, btnId]) => {
                const btn = document.getElementById(btnId);
                if (!btn) return;

                if (period === currentPeriod) {
                    btn.className = 'px-4 h-full text-sm font-medium rounded-md bg-primary text-white';
                } else {
                    btn.className =
                        'px-4 h-full text-sm font-medium rounded-md text-text-primary-light dark:text-text-primary-dark hover:bg-black/5 dark:hover:bg-white/5';
                }
            });
        }

        function setupEventListeners() {
            const toggle = document.getElementById('darkModeToggle');
            if (toggle) {
                toggle.addEventListener('click', () => {
                    document.documentElement.classList.toggle('dark');
                });
            }
        }

        function showLoading() {
            const content = document.getElementById('dashboardContent');
            if (content) content.classList.add('loading');
        }

        function hideLoading() {
            const content = document.getElementById('dashboardContent');
            if (content) content.classList.remove('loading');
        }

        function showError(message) {
            console.error('Dashboard error:', message);
            alert(message);
        }
    </script>
</body>

</html>