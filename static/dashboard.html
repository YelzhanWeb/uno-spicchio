<!DOCTYPE html>
<html class="light" lang="ru">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>UNO Spicchio - Dashboard</title>

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <!-- Chart.js для графика продаж -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@100..700,0..1&display=swap"
        rel="stylesheet" />

    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#d32f2f",
                        "background-light": "#f5f5f5",
                        "background-dark": "#1a1a1a",
                        "surface-light": "#ffffff",
                        "surface-dark": "#2a2a2a",
                        "text-primary-light": "#333333",
                        "text-primary-dark": "#e0e0e0",
                        "text-secondary-light": "#666666",
                        "text-secondary-dark": "#b3b3b3",
                        "border-light": "#e0e0e0",
                        "border-dark": "#444444",
                        positive: "#4caf50",
                    },
                    fontFamily: {
                        display: ["Inter", "sans-serif"],
                    },
                    borderRadius: {
                        lg: "0.75rem",
                        xl: "1rem",
                    },
                },
            },
        };
    </script>

    <style>
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .material-symbols-outlined.fill {
            font-variation-settings: 'FILL' 1;
        }

        .chart-bar {
            transition: width 0.3s ease-in-out;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .metric-card {
            animation: slideInUp 0.4s ease-out;
        }

        .metric-card:nth-child(1) {
            animation-delay: 0s;
        }

        .metric-card:nth-child(2) {
            animation-delay: 0.1s;
        }

        .metric-card:nth-child(3) {
            animation-delay: 0.2s;
        }

        .metric-card:nth-child(4) {
            animation-delay: 0.3s;
        }
    </style>
</head>

<body
    class="font-display bg-background-light dark:bg-background-dark text-text-primary-light dark:text-text-primary-dark">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside
            class="w-64 flex-shrink-0 bg-white dark:bg-gray-800 p-6 border-r border-gray-200 dark:border-gray-700 flex flex-col">
            <div class="mb-10">
                <h1 class="text-xl font-bold text-gray-900 dark:text-white">UNO Spicchio</h1>
                <p class="text-sm text-gray-500 dark:text-gray-400">Admin Panel</p>
            </div>

            <nav class="flex flex-col space-y-2 flex-1">
                <div class="px-4 py-3 bg-red-50 dark:bg-gray-700 rounded-lg">
                    <p class="font-semibold text-primary">UNO Spicchio</p>
                </div>

                <a href="active-orders.html" class="flex items-center gap-2 px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700
                  text-gray-600 dark:text-gray-300">
                    <span class="material-symbols-outlined">receipt_long</span>
                    <span>Все заказы</span>
                </a>

                <a id="createOrderLink" href="create-order.html" class="flex items-center gap-2 px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700
                  text-gray-600 dark:text-gray-300">
                    <span class="material-symbols-outlined">add_shopping_cart</span>
                    <span>Создать заказ</span>
                </a>

                <a id="chefLink" href="chef-orders.html" class="flex items-center gap-2 px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700
                  text-gray-600 dark:text-gray-300">
                    <span class="material-symbols-outlined">restaurant</span>
                    <span>Кухня</span>
                </a>

                <a id="employeesLink" href="employees.html"
                    class="flex items-center gap-2 px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300">
                    <span class="material-symbols-outlined">group</span>
                    <span>Сотрудники</span>
                </a>

                <a id="menuLink" href="menu.html" class="flex items-center gap-2 px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700
                  text-gray-600 dark:text-gray-300">
                    <span class="material-symbols-outlined">restaurant_menu</span>
                    <span>Меню</span>
                </a>

                <a id="dashboardLink" href="dashboard.html" class="flex items-center gap-2 px-4 py-3 bg-red-100/50 dark:bg-gray-700/50 rounded-lg
                  font-medium text-gray-900 dark:text-white">
                    <span class="material-symbols-outlined">analytics</span>
                    <span>Аналитика</span>
                </a>

                <a id="inventoryLink" href="inventory.html" class="flex items-center gap-2 px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700
                  text-gray-600 dark:text-gray-300">
                    <span class="material-symbols-outlined">inventory_2</span>
                    <span>Склад</span>
                </a>
            </nav>

            <div class="mt-6">
                <div class="border-t border-gray-200 dark:border-gray-700 pt-3 space-y-3 text-sm">
                    <div class="px-3">
                        <p id="userFullName" class="font-semibold text-gray-900 dark:text-white">Loading...</p>
                        <p id="userRole" class="text-xs text-gray-500 dark:text-gray-400">...</p>
                    </div>

                    <a href="#" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-600 dark:text-gray-400
                      hover:bg-gray-100 dark:hover:bg-gray-700">
                        <span class="material-symbols-outlined text-xl">help</span>
                        <span>Help</span>
                    </a>

                    <a href="#" onclick="logout(); return false;" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-600 dark:text-gray-400
                      hover:bg-gray-100 dark:hover:bg-gray-700">
                        <span class="material-symbols-outlined text-xl">logout</span>
                        <span>Log Out</span>
                    </a>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col">
            <!-- Header -->
            <header
                class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
                <div></div>
                <div class="flex items-center space-x-4">
                    <button onclick="logout()"
                        class="text-sm text-gray-600 dark:text-gray-300 hover:text-primary transition-colors">
                        Выход
                    </button>
                    <img alt="Аватар пользователя" class="h-10 w-10 rounded-full object-cover"
                        src="https://i.pravatar.cc/40" />
                </div>
            </header>

            <!-- Content -->
            <div class="flex-1 p-8 overflow-y-auto">
                <div class="max-w-7xl mx-auto flex flex-col gap-8" id="dashboardContent">

                    <!-- Header + Period buttons + Dark toggle -->
                    <div class="flex flex-wrap justify-between items-start gap-4">
                        <div class="flex flex-col gap-2">
                            <p class="text-3xl md:text-4xl font-black tracking-tight">Reports Dashboard</p>
                            <p class="text-base text-text-secondary-light dark:text-text-secondary-dark">
                                Buona giornata! Here's your restaurant's performance overview.
                            </p>
                        </div>
                        <div class="flex items-center gap-4">
                            <!-- Segmented period buttons -->
                            <div
                                class="flex h-10 items-center justify-center rounded-lg bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark p-1 shadow-sm">
                                <button id="btnYesterday" onclick="loadDashboard('yesterday')"
                                    class="px-4 h-full text-sm font-medium rounded-md text-text-primary-light dark:text-text-primary-dark hover:bg-black/5 dark:hover:bg-white/5">
                                    Yesterday
                                </button>
                                <button id="btnToday" onclick="loadDashboard('today')"
                                    class="px-4 h-full text-sm font-medium rounded-md bg-primary text-white">
                                    Today
                                </button>
                                <button id="btnCurrentMonth" onclick="loadDashboard('current_month')"
                                    class="px-4 h-full text-sm font-medium rounded-md text-text-primary-light dark:text-text-primary-dark hover:bg-black/5 dark:hover:bg-white/5">
                                    Current Month
                                </button>
                            </div>

                            <!-- Dark mode toggle -->
                            <button id="darkModeToggle"
                                class="p-2 rounded-full bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark hover:bg-black/5 dark:hover:bg-white/5">
                                <span
                                    class="material-symbols-outlined text-text-secondary-light dark:text-text-secondary-dark">
                                    dark_mode
                                </span>
                            </button>
                        </div>
                    </div>

                    <!-- Overview cards -->
                    <div>
                        <h2 id="overviewTitle" class="text-2xl font-bold mb-4 text-gray-900 dark:text-white">
                            Today's Overview
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <!-- Revenue -->
                            <div
                                class="metric-card bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 border border-gray-200 dark:border-gray-700">
                                <div class="flex items-center justify-between mb-3">
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Revenue</p>
                                    <div
                                        class="w-10 h-10 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center">
                                        <span
                                            class="material-symbols-outlined text-green-600 dark:text-green-400">payments</span>
                                    </div>
                                </div>
                                <p id="metricRevenue" class="text-3xl font-bold text-gray-900 dark:text-white mb-1">0 ₸
                                </p>
                                <p id="metricRevenueChange"
                                    class="text-sm font-medium text-green-600 dark:text-green-400">+0%</p>
                            </div>

                            <!-- Total Orders -->
                            <div
                                class="metric-card bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 border border-gray-200 dark:border-gray-700">
                                <div class="flex items-center justify-between mb-3">
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Total Orders</p>
                                    <div
                                        class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                                        <span
                                            class="material-symbols-outlined text-blue-600 dark:text-blue-400">receipt_long</span>
                                    </div>
                                </div>
                                <p id="metricOrders" class="text-3xl font-bold text-gray-900 dark:text-white mb-1">0</p>
                                <p id="metricOrdersChange" class="text-sm font-medium text-blue-600 dark:text-blue-400">
                                    +0%</p>
                            </div>

                            <!-- Average Order Value -->
                            <div
                                class="metric-card bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 border border-gray-200 dark:border-gray-700">
                                <div class="flex items-center justify-between mb-3">
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Avg Order Value</p>
                                    <div
                                        class="w-10 h-10 rounded-full bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center">
                                        <span
                                            class="material-symbols-outlined text-purple-600 dark:text-purple-400">trending_up</span>
                                    </div>
                                </div>
                                <p id="metricAvgValue" class="text-3xl font-bold text-gray-900 dark:text-white mb-1">0 ₸
                                </p>
                                <p id="metricAvgValueChange"
                                    class="text-sm font-medium text-purple-600 dark:text-purple-400">+0%</p>
                            </div>

                            <!-- Completed Orders -->
                            <div
                                class="metric-card bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 border border-gray-200 dark:border-gray-700">
                                <div class="flex items-center justify-between mb-3">
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Completed Orders</p>
                                    <div
                                        class="w-10 h-10 rounded-full bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center">
                                        <span
                                            class="material-symbols-outlined text-orange-600 dark:text-orange-400">task_alt</span>
                                    </div>
                                </div>
                                <p id="metricCompleted" class="text-3xl font-bold text-gray-900 dark:text-white mb-1">0
                                </p>
                                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">
                                    of <span id="metricTotal">0</span> total
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Sales Analytics chart -->
                    <div
                        class="bg-surface-light dark:bg-surface-dark p-6 rounded-xl border border-border-light dark:border-border-dark">
                        <div class="flex items-center justify-between mb-2">
                            <div>
                                <h3 class="text-lg font-semibold">Sales Analytics</h3>
                                <p class="text-sm text-text-secondary-light dark:text-text-secondary-dark">
                                    Revenue vs Time
                                </p>
                            </div>
                            <div class="flex flex-col items-end gap-2">
                                <!-- Переключатели диапазона -->
                                <div
                                    class="flex h-8 items-center justify-center rounded-full bg-white/70 dark:bg-black/20 border border-border-light dark:border-border-dark px-1 shadow-sm">
                                    <button id="btnSalesToday" onclick="loadSalesAnalytics('today')"
                                        class="px-3 h-6 text-xs font-medium rounded-full bg-primary text-white">
                                        Today
                                    </button>
                                    <button id="btnSalesWeek" onclick="loadSalesAnalytics('week')"
                                        class="px-3 h-6 text-xs font-medium rounded-full text-text-primary-light dark:text-text-primary-dark hover:bg-black/5 dark:hover:bg-white/5">
                                        7 days
                                    </button>
                                    <button id="btnSalesMonth" onclick="loadSalesAnalytics('month')"
                                        class="px-3 h-6 text-xs font-medium rounded-full text-text-primary-light dark:text-text-primary-dark hover:bg-black/5 dark:hover:bg-white/5">
                                        30 days
                                    </button>
                                </div>

                                <div class="text-right">
                                    <p id="salesChartTotal" class="text-2xl font-bold text-gray-900 dark:text-white">
                                        0 ₸
                                    </p>
                                    <p id="salesChartChange"
                                        class="text-xs font-medium text-green-600 dark:text-green-400">
                                        <!-- +12% -->
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 h-64">
                            <canvas id="salesChart" class="w-full h-full"></canvas>
                        </div>
                    </div>

                    <!-- Charts & Popular Dishes -->
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                        <!-- Sales by Category -->
                        <div
                            class="lg:col-span-3 bg-surface-light dark:bg-surface-dark p-6 rounded-xl border border-border-light dark:border-border-dark">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold">Sales by Category</h3>
                            </div>
                            <div id="categorySales" class="flex-1 flex flex-col space-y-4">
                                <!-- JS -->
                            </div>
                        </div>

                        <!-- Popular Dishes -->
                        <div
                            class="lg:col-span-2 bg-surface-light dark:bg-surface-dark p-6 rounded-xl border border-border-light dark:border-border-dark">
                            <h3 class="text-lg font-semibold mb-4">Popular Dishes</h3>
                            <ul id="popularDishes" class="space-y-4">
                                <!-- JS -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8080/api';
        let currentPeriod = 'today';
        let authToken = '';
        let currentUser = null;
        let salesChart = null;         // Chart.js instance
        let salesRange = 'today';      // today | week | month

        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            setupEventListeners();
        });

        function checkAuth() {
            authToken = localStorage.getItem('auth_token');
            if (!authToken) {
                window.location.href = 'login.html';
                return;
            }
            loadUserInfo();
            loadDashboard('today');
        }

        function logout() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_data');
            window.location.href = 'login.html';
        }

        async function loadUserInfo() {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const result = await response.json();

                    if (result.success && result.data) {
                        currentUser = result.data;
                    } else if (result.id) {
                        currentUser = result;
                    }

                    if (currentUser) {
                        document.getElementById('userFullName').textContent = currentUser.username;
                        document.getElementById('userRole').textContent = currentUser.role;

                        if (currentUser.role !== 'waiter' && currentUser.role !== 'admin') {
                            const createOrderLink = document.getElementById('createOrderLink');
                            if (createOrderLink) createOrderLink.style.display = 'none';
                        }

                        const chefLink = document.getElementById('chefLink');
                        if (chefLink && currentUser.role !== 'cook' &&
                            currentUser.role !== 'waiter' &&
                            currentUser.role !== 'admin') {
                            chefLink.style.display = 'none';
                        }

                        const inventoryLink = document.getElementById('inventoryLink');
                        if (inventoryLink && currentUser.role !== 'admin') {
                            inventoryLink.style.display = 'none';
                        }

                        if (currentUser.role !== 'admin' && currentUser.role !== 'manager') {
                            alert('У вас нет прав для просмотра аналитики');
                            window.location.href = 'active-orders.html';
                        }
                    }
                } else {
                    logout();
                }
            } catch (error) {
                console.error('Error loading user info:', error);
                logout();
            }
        }

        async function loadDashboard(period) {
            currentPeriod = period;
            updatePeriodButtons();
            showLoading();

            try {
                const response = await fetch(`${API_BASE_URL}/analytics/dashboard?period=${period}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const result = await response.json();
                    let data;
                    if (result.success && result.data) {
                        data = result.data;
                    } else if (result.summary) {
                        data = result;
                    } else {
                        console.error('Invalid data format:', result);
                        showError('Invalid dashboard data format');
                        return;
                    }

                    updateDashboard(data);
                    // Загружаем график продаж
                    loadSalesAnalytics(salesRange);
                } else {
                    const errorText = await response.text();
                    console.error('Failed to load dashboard:', response.status, errorText);
                    showError('Failed to load dashboard data: ' + response.status);
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showError('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function updateDashboard(data) {
            const summary = data.summary || {};
            const categorySales = data.category_sales || [];
            const popularDishes = data.popular_dishes || [];

            updateOverview(summary);
            updateCategorySales(categorySales);
            updatePopularDishes(popularDishes);
        }

        function periodTitle() {
            switch (currentPeriod) {
                case 'yesterday': return "Yesterday's Overview";
                case 'current_month': return "Current Month Overview";
                default: return "Today's Overview";
            }
        }

        function updateOverview(summary) {
            const titleEl = document.getElementById('overviewTitle');
            if (titleEl) titleEl.textContent = periodTitle();

            const totalRevenue = summary.total_revenue || 0;
            const totalOrders = summary.total_orders || 0;
            const avgOrderValue = summary.average_order_value || 0;
            const completedOrders = summary.completed_orders || 0;

            document.getElementById('metricRevenue').textContent = totalRevenue.toFixed(0) + ' ₸';
            document.getElementById('metricOrders').textContent = totalOrders;
            document.getElementById('metricAvgValue').textContent = avgOrderValue.toFixed(0) + ' ₸';
            document.getElementById('metricCompleted').textContent = completedOrders;
            document.getElementById('metricTotal').textContent = totalOrders;

            const revenueChange = summary.revenue_change || 0;
            const ordersChange = summary.orders_change || 0;
            const avgChange = summary.avg_value_change || 0;

            setChangeClassAndText('metricRevenueChange', revenueChange);
            setChangeClassAndText('metricOrdersChange', ordersChange, 'blue');
            setChangeClassAndText('metricAvgValueChange', avgChange, 'purple');
        }

        function setChangeClassAndText(id, value, color = 'green') {
            const el = document.getElementById(id);
            if (!el) return;

            const positive = value >= 0;
            const baseColor =
                color === 'blue' ? 'blue-600'
                    : color === 'purple' ? 'purple-600'
                        : 'green-600';

            const classNamePositive = `text-sm font-medium text-${baseColor} dark:text-${baseColor.replace('600', '400')}`;
            const classNameNegative = 'text-sm font-medium text-red-600 dark:text-red-400';

            el.className = positive ? classNamePositive : classNameNegative;
            el.textContent = `${positive ? '+' : ''}${value.toFixed(1)}%`;
        }

        // --- Sales Analytics chart (rev vs time) ---
        async function loadSalesAnalytics(range = 'today') {
            salesRange = range;
            updateSalesRangeButtons();

            try {
                const response = await fetch(`${API_BASE_URL}/analytics/sales/hourly?range=${range}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    console.error('Failed to load hourly revenue:', response.status);
                    return;
                }

                const result = await response.json();
                const data = result.data || result; // ожидаем массив [{hour, revenue, orders} ...]

                if (!Array.isArray(data) || data.length === 0) {
                    if (salesChart) {
                        salesChart.destroy();
                        salesChart = null;
                    }
                    document.getElementById('salesChartTotal').textContent = '0 ₸';
                    document.getElementById('salesChartChange').textContent = '';
                    return;
                }

                // Подписи зависят от диапазона
                const labels = data.map((point, index) =>
                    getLabelForRange(range, point, index)
                );
                const values = data.map(d => d.revenue || 0);

                const total = values.reduce((acc, v) => acc + v, 0);
                document.getElementById('salesChartTotal').textContent =
                    `${total.toFixed(0)} ₸`;
                document.getElementById('salesChartChange').textContent = '';

                const ctx = document.getElementById('salesChart').getContext('2d');

                const gradient = ctx.createLinearGradient(0, 0, 0, 260);
                gradient.addColorStop(0, 'rgba(249, 115, 22, 0.35)');
                gradient.addColorStop(1, 'rgba(249, 115, 22, 0)');

                if (salesChart) {
                    salesChart.destroy();
                }

                salesChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Revenue',
                            data: values,
                            tension: 0.45,
                            fill: true,
                            borderWidth: 2.5,
                            borderColor: '#f97316',
                            backgroundColor: gradient,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            pointBackgroundColor: '#ffffff',
                            pointBorderColor: '#f97316',
                            pointBorderWidth: 1.5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#111827',
                                titleColor: '#f9fafb',
                                bodyColor: '#e5e7eb',
                                padding: 10,
                                cornerRadius: 8,
                                callbacks: {
                                    label: (ctx) => {
                                        const v = ctx.parsed.y || 0;
                                        return `${v.toFixed(0)} ₸`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { display: false },
                                ticks: {
                                    maxTicksLimit: range === 'today' ? 12 : 8,
                                    color: '#9ca3af'
                                }
                            },
                            y: {
                                grid: { color: 'rgba(156, 163, 175, 0.15)' },
                                ticks: {
                                    color: '#9ca3af',
                                    callback: (value) => value + ' ₸'
                                }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('Error loading hourly revenue:', error);
            }
        }
        function getLabelForRange(range, point, index) {
            if (range === 'today') {
                // 00:00–23:00
                const h = (point.hour !== undefined && point.hour !== null)
                    ? point.hour
                    : index;
                return `${String(h).padStart(2, '0')}:00`;
            }

            if (range === 'week') {
                // Дни недели
                const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                return days[index % 7];
            }

            if (range === 'month') {
                // 1–30 (или сколько есть точек)
                return String(index + 1);
            }

            // запасной вариант – если бек вернёт готовый label
            if (point.label) return point.label;

            return `${String(point.hour || 0).padStart(2, '0')}:00`;
        }



        function updateSalesRangeButtons() {
            const active =
                'px-3 h-6 text-xs font-medium rounded-full bg-primary text-white';
            const inactive =
                'px-3 h-6 text-xs font-medium rounded-full text-text-primary-light dark:text-text-primary-dark hover:bg-black/5 dark:hover:bg-white/5';

            const btnToday = document.getElementById('btnSalesToday');
            const btnWeek = document.getElementById('btnSalesWeek');
            const btnMonth = document.getElementById('btnSalesMonth');

            if (!btnToday || !btnWeek || !btnMonth) return;

            btnToday.className = salesRange === 'today' ? active : inactive;
            btnWeek.className = salesRange === 'week' ? active : inactive;
            btnMonth.className = salesRange === 'month' ? active : inactive;
        }

        function updateCategorySales(sales) {
            const container = document.getElementById('categorySales');

            const barColors = [
                'bg-red-500',
                'bg-emerald-500',
                'bg-blue-500',
                'bg-amber-500',
                'bg-violet-500',
                'bg-orange-500'
            ];

            if (!sales || sales.length === 0) {
                container.innerHTML =
                    '<p class="text-text-secondary-light dark:text-text-secondary-dark">No sales data available for this period</p>';
                return;
            }

            container.innerHTML = sales.map((sale, index) => {
                const barColorClass = barColors[index % barColors.length];
                const percentage = sale.percentage || 0;
                const revenue = sale.revenue || 0;

                return `
      <div class="flex items-center gap-4">
        <div class="w-32 text-sm text-text-secondary-light dark:text-text-secondary-dark truncate">
          ${sale.category_name}
        </div>
        <div class="flex-1 bg-slate-800/90 dark:bg-slate-800 rounded-full h-3">
          <div class="${barColorClass} h-3 rounded-full chart-bar" style="width: ${Math.min(percentage, 100)}%;"></div>
        </div>
        <div class="w-24 text-right">
          <div class="font-semibold">${revenue.toFixed(0)} ₸</div>
          <div class="text-xs text-text-secondary-light dark:text-text-secondary-dark">${percentage.toFixed(1)}%</div>
        </div>
      </div>
    `;
            }).join('');
        }

        function updatePopularDishes(dishes) {
            const container = document.getElementById('popularDishes');

            const dishStyles = [
                { icon: 'local_pizza', bg: 'bg-red-100', bgDark: 'dark:bg-red-900/30', text: 'text-red-500' },
                { icon: 'ramen_dining', bg: 'bg-emerald-100', bgDark: 'dark:bg-emerald-900/30', text: 'text-emerald-500' },
                { icon: 'tapas', bg: 'bg-blue-100', bgDark: 'dark:bg-blue-900/30', text: 'text-blue-500' },
                { icon: 'cake', bg: 'bg-amber-100', bgDark: 'dark:bg-amber-900/30', text: 'text-amber-500' },
                { icon: 'local_bar', bg: 'bg-orange-100', bgDark: 'dark:bg-orange-900/30', text: 'text-orange-500' }
            ];

            if (!dishes || dishes.length === 0) {
                container.innerHTML =
                    '<p class="text-text-secondary-light dark:text-text-secondary-dark">No popular dishes data available for this period</p>';
                return;
            }

            container.innerHTML = dishes.map((dish, index) => {
                const style = dishStyles[index % dishStyles.length];
                const revenue = dish.revenue || 0;
                const qtySold = dish.qty_sold || 0;

                return `
      <li class="flex items-center">
        <div class="w-10 h-10 ${style.bg} ${style.bgDark} rounded-full flex items-center justify-center mr-4">
          <span class="material-symbols-outlined ${style.text}">${style.icon}</span>
        </div>
        <div class="flex-1">
          <span class="font-medium">${dish.dish_name}</span>
          <p class="text-sm text-text-secondary-light dark:text-text-secondary-dark">${qtySold} sold</p>
        </div>
        <span class="font-semibold">${revenue.toFixed(0)} ₸</span>
      </li>
    `;
            }).join('');
        }

        function updatePeriodButtons() {
            const buttons = {
                'yesterday': 'btnYesterday',
                'today': 'btnToday',
                'current_month': 'btnCurrentMonth'
            };

            Object.entries(buttons).forEach(([period, btnId]) => {
                const btn = document.getElementById(btnId);
                if (!btn) return;

                if (period === currentPeriod) {
                    btn.className = 'px-4 h-full text-sm font-medium rounded-md bg-primary text-white';
                } else {
                    btn.className =
                        'px-4 h-full text-sm font-medium rounded-md text-text-primary-light dark:text-text-primary-dark hover:bg-black/5 dark:hover:bg-white/5';
                }
            });
        }

        function setupEventListeners() {
            const toggle = document.getElementById('darkModeToggle');
            if (toggle) {
                toggle.addEventListener('click', () => {
                    document.documentElement.classList.toggle('dark');
                });
            }
        }

        function showLoading() {
            const content = document.getElementById('dashboardContent');
            if (content) content.classList.add('loading');
        }

        function hideLoading() {
            const content = document.getElementById('dashboardContent');
            if (content) content.classList.remove('loading');
        }

        function showError(message) {
            console.error('Dashboard error:', message);
            alert(message);
        }
    </script>
</body>

</html>